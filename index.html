<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title></title>
	<style type="text/css">

	body {
		background: black;
		color: white;
		font-family: system-ui;
	}

	canvas {
		outline: snow 3px solid;
/*		height: 97vh;*/
		image-rendering: pixelated;
		position: absolute;
		top: 50%;
		left: 50%;
		transform: translate(-50%, -50%);

	}

	label {
	}
	input {
		display:block;
		-moz-appearance: none;
		-webkit-appearance: none;
		border: 1px solid transparent;
		box-shadow: none;
		height: 1em;		
		padding-top: calc(.75em);
		padding-bottom: calc(.75em);
		padding-left: calc(.75em);
		font-size: 16px;
		padding: 4px;
		margin-bottom: 4px;

	}

	input {
		background-color: #404040;
		border-radius: 0!important;
		border: #2b2b2b;
		color: #b9c8aa;
	}

	</style>
</head>

	<label>px/mm</label>
	<input type="number" id="pxmm" value="1" min="0" step="1">

	<label>grid size (mm)</label>
	<input type="number" id="gs" value="20" min="1" step="1">


	<label>w</label>
	<input type="number" id="w" value="300" min="0" step="1">

	<label>h</label>
	<input type="number" id="h" value="300" min="0" step="1">

	<label>qty</label>
	<input type="number" id="qty" value="1" min="1" step="1" max="10">

	<template>
		<div style="display: table;outline: auto;">
			<label>a1</label>
			<input type="number" id="a1_" value="80" min="0" step="1">

			<label>a2</label>
			<input type="number" id="a2_" value="80" min="0" step="1">


			<label>a1w</label>
			<input type="number" id="a1w_" value="15" min="1" step="1">

			<label>a2w</label>
			<input type="number" id="a2w_" value="10" min="1" step="1">


			<label>x0</label>
			<input type="number" id="x0_" value="120" min="0" step="1">

			<label>y0</label>
			<input type="number" id="y0_" value="150" min="0" step="1">

			<label>br</label>
			<input type="number" id="br_" value="20" min="0" step="1">
		</div>
	</template>
	
	<div id="arms"></div>




<!-- negative:<input type="checkbox" id="negative"> -->

<canvas id="canvas" width="300px" height="300px"></canvas>

<script type="text/javascript">
	let getInput = (id) => {
		return Math.round(parseFloat(document.getElementById(id).value))
	}

	let inputsArray = (root) => {
		return Array.from(root.querySelectorAll('*')).filter(el => el.tagName === 'INPUT')
	}

	getState = () => {
		let root = document.getElementById('arms')
		let stateObj = inputsArray(root).reduce((a, c) => {a[c.id] = c.value;return a}, {})
		return stateObj
	}

	let addArm = () => {
		let stateObj = getState()
		let templ = document.getElementsByTagName("template")[0];
		document.getElementById('arms').innerHTML = ''
		for (let i = 0; i < getInput('qty'); i++) {
			let clon = templ.content.cloneNode(true)
			inputsArray(clon).forEach(el => el.id += i)
			document.getElementById('arms').appendChild(clon)
		}
		
		Object.keys(stateObj).forEach(k => {
			let el = document.getElementById(k)
			if (el) el.value = stateObj[k]
		})
		
	}
	addArm()
	document.getElementById("qty").addEventListener('change', addArm)

	let xy = {}

	let canvas = document.getElementById("canvas")
	let ctx = canvas.getContext("2d")
	
	let draw = () => {
		// convert mm to px
		let pxmm = getInput('pxmm')

		canvas.width = getInput('w')*pxmm
		canvas.height = getInput('h')*pxmm

		// clear canvas
		ctx.clearRect(0, 0, canvas.width, canvas.height)

		ctx.fillStyle = 'black';
		ctx.fillRect(0, 0, canvas.width, canvas.height);

		// set grid
		let gs = getInput('gs')
		ctx.beginPath()

		ctx.lineWidth = 1
		ctx.strokeStyle = '#ffffff';


		for (let i = 0; i < canvas.width/pxmm; i=i+gs) {
			ctx.moveTo(i*pxmm, 0)
			ctx.lineTo(i*pxmm, canvas.height)
		}

		for (let i = 0; i < canvas.height/pxmm; i=i+gs) {
			ctx.moveTo(0, i*pxmm)
			ctx.lineTo(canvas.width, i*pxmm)
		}
		ctx.stroke()

		
		for (let i = 0; i < getInput('qty'); i++) {
			let x = xy['x_'+i]
			let y = xy['y_'+i]

			// origin
			let x0 = getInput('x0_'+i)
			let y0 = getInput('y0_'+i)


			// draw base
			ctx.beginPath();
			ctx.lineWidth = 1
			ctx.strokeStyle = '#ffffff';

			ctx.arc(x0, y0, getInput('br_'+i), 0, 2 * Math.PI);
			ctx.fill();
			ctx.stroke();

			
			// segments size
			let a1 = getInput('a1_'+i)*pxmm
			let a2 = getInput('a2_'+i)*pxmm

			// do the math
			let q2
			let q1
			
			// if (document.getElementById("negative").checked) {
			// 	q2 = -Math.acos((x*x+y*y-a1*a1-a2*a2)/(2*a1*a2))
			// 	q1 = Math.atan2(y,x)+Math.atan((a2*Math.sin(q2))/(a1+a2*Math.cos(q2)))
			// } else {
				q2 = Math.acos((x*x+y*y-a1*a1-a2*a2)/(2*a1*a2))
				q1 = Math.atan2(y,x)-Math.atan((a2*Math.sin(q2))/(a1+a2*Math.cos(q2)))
			// }

			let p1x = Math.cos(q1)*a1
			let p1y = Math.sin(q1)*a1

			let p2x = Math.cos(q1+q2)*a2 + p1x
			let p2y = Math.sin(q1+q2)*a2 + p1y

			// draw arm
			ctx.beginPath()
			ctx.moveTo(x0, y0)

			ctx.lineWidth = getInput('a1w_'+i)
			ctx.strokeStyle = '#ff0000';
			
			ctx.lineTo(p1x+x0, p1y+y0)
			ctx.stroke()

			ctx.beginPath()

			ctx.moveTo(p1x+x0, p1y+y0)

			ctx.lineWidth = getInput('a2w_'+i)
			ctx.strokeStyle = '#00ff00';

			ctx.lineTo(p2x+x0, p2y+y0)
			ctx.stroke()
			
		}

	}

	let addEventListeners = () => {
		Array.from(document.getElementsByTagName("input")).forEach(el => {
			el.addEventListener('change', draw)
		})
	}
	addEventListeners()

	canvas.addEventListener('mousemove', function(evt) {
		for (let i = 0; i < getInput('qty'); i++) {
			// origin
			let x0 = getInput('x0_'+i)
			let y0 = getInput('y0_'+i)

			// get x y from canvas
			let rect = canvas.getBoundingClientRect()
			let x = evt.clientX - rect.left - x0
			let y = evt.clientY - rect.top - y0
			xy['x_'+i] = x
			xy['y_'+i] = y

		}
		
		draw()
	}, false)

</script>
</body>
</html>
